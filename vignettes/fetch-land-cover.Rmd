---
title: "Fetching and pre-processing landcover data"
author: "Lyndon Estes"
date: "04/11/2014"
output: html_document
---

### Introduction
Fetching and pre-processing of global landcover datasets to be analyzed relative to the SA dataset: the MODIS 2011 landcover product for South Africa was downloaded, the GLC-SHARE dataset, the 2009 GlobCover product, South Africa's 2009 landcover product, and geo-wiki's cropland fusion map. These were converted to 1 km$^2$ percentage cropland estimates after making several versions of MODIS and GlobCover products to account for mixed cropland classes.  A further processing was applied to the two GTI derived cover images.  

### Analyses
#### Set-up
```{r, eval = FALSE}
library(SAcropland)
library(gdalUtils)
library(RCurl)
library(RPostgreSQL)
library(rgdal)
library(rgeos)
library(raster)
library(lmisc)
```

Paths
```{r, eval = FALSE}
#setwd("/u/lestes/analyses/SAcropland/")
p_root <- proj_root("SAcropland")
p_fig <- full_path(p_root, "SAcropland/external/figures/")
p_data <- full_path(p_root, "SAcropland/external/ext_data/")
```

Background data, projections, database connections, and SA grid
```{r, eval = FALSE}
# Get SA shape
if(!file.exists(full_path(p_data, "MZshapes.Rdata"))) {
  system("wget http://dl.dropboxusercontent.com/u/31890709/MZshapes.Rdata")
}
load(full_path(p_data, "MZshapes.Rdata"))
sa_buf <- gBuffer(sa.shp, width = 3000)

# Connection
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = "SouthAfricaSandbox", user = "postgis", password = "P0stG1S")

# projections, etc
prjsrid <- 97490  # Albers
prj_sql <- paste("select proj4text from spatial_ref_sys where srid=", prjsrid, sep = "")
prjstr <- dbGetQuery(con, prj_sql)$proj4text
gcsid <- 4326  # GCS
gcs_sql <- paste("select proj4text from spatial_ref_sys where srid=", gcsid, sep = "")
gcsstr <- dbGetQuery(con, gcs_sql)$proj4text

# Convert SA to GCS for cropping extent
sa_buf_gcs <- spTransform(sa_buf, CRSobj = CRS(gcsstr))

# Create 1 km grid from sa1kilo to rectify grids against that 
if(!file.exists(full_path(p_data, "sagrid.tif"))) {  # Wrap in if statement in case grid already made
  sql <- paste("SELECT gid, id, ST_AsText(ST_Centroid(geom)) as center FROM sa1kilo")
  geom.tab <- dbGetQuery(con, sql)
  coord.mat <- do.call(rbind, lapply(1:nrow(geom.tab), function(y) {
    strip <- gsub("POINT|\\(|\\)", "", geom.tab[y, 3])
    coord.mat <- do.call(rbind, strsplit(strsplit(strip, ",")[[1]], " "))
  }))
  class(coord.mat) <- "numeric"
  point.tab <- cbind(geom.tab[, 1:2], coord.mat)
  colnames(point.tab)[3:4] <- c("x", "y") 
  pointsXYZ <- point.tab[, c(3:4, 2)]
  sa_r <- rasterFromXYZ(pointsXYZ)
  projection(sa_r) <- sa.buf@proj4string
  sa_r <- writeRaster(sa_r, filename = full_path(p_data, "sagrid.tif"), overwrite = TRUE)
} else {
  sa_r <- raster(full_path(p_data, "sagrid.tif"))
}
```

#### Bring in landcover datasets
Let's start with the improved/fusion datasets, GLC share and geo-wiki's
```{r, eval = FALSE}
if(!file.exists(full_path(p_data, "glcsa_masked.tif"))) {  # see if file exists, to avoid redoing step
  setwd("/u/lestes/spatial_data/")
  path <- "/u/lestes/spatial_data/glc_share/"
  url <- "http://www.fao.org/geonetwork/srv/en/resources.get?id=47948&fname=GlcShare_v10_02.zip&acces=private"
  download.file(url, method = "auto", destfile = "glc_share.zip")
  unzip("glc_share.zip", exdir = "glc_share")
  glc <- raster(full_path(path, "glc_shv10_02.Tif"))
  projection(glc) <- gcsstr
  glcSA <- crop(glc, y=sa_buf_gcs, file = full_path(path, "glcSA.tif"), overwrite = TRUE)  # crop to SA
  gdalwarp(srcfile = glcSA@file@name, dstfile = full_path(path, "glcSA_alb.tif"), t_srs = prjstr, 
           tr = c(1000, 1000), r = "bilinear")
  glcSA_alb <- raster(full_path(path, "glcSA_alb.tif"))

  # Warp to SA grid
  glcsa <- resample(glcSA_alb, sa_r, method = "bilinear", filename = full_path(path, "glcSA_alb_rect.tif"))
  glcsa_m <- mask(glcsa, sa_r, file = full_path(p_data, "glcsa_masked.tif"), overwrite = TRUE)
} else {
  glcsa_m <- raster(full_path(p_data, "glcsa_masked.tif"))
}

if(!file.exists(full_path(p_data, "geowikisa_masked.tif"))) {  # see if file exists, to avoid redoing step 
  setwd("/u/lestes/spatial_data/")
   # first downloaded manually from password protected geo-wiki site
  path <- "/u/lestes/spatial_data/geowiki/"
  unzip("cropland_hybrid_14052014v8.zip", exdir= "geowiki") 
  geowiki <- raster(full_path(path, "Hybrid_14052014V8.img"))
  projection(geowiki) <- gcsstr
  geowikiSA <- crop(geowiki, y=sa_buf_gcs, file = full_path(path, "geowikiSA.tif"))  # crop to extent of SA
  gdalwarp(srcfile = geowikiSA@file@name, dstfile = full_path(path, "geowikiSA_alb.tif"), t_srs = prjstr, 
           tr = c(1000, 1000), r = "bilinear")
  geowikisa_alb <- raster(full_path(path, "geowikiSA_alb.tif"))
  geowikisa <- resample(geowikisa_alb, sa_r, method = "bilinear", 
                        filename = full_path(path, "geowikisa_alb_rect.tif"))    # Warp to SA grid
  geowikisa_m <- mask(glcsa, sa_r, file = full_path(p_data, "geowikisa_masked.tif"), overwrite = TRUE)
} else {
  geowikisa_m <- raster(full_path(p_data, "geowikisa_masked.tif"))
}
```

And the standard products, Globcover 2009 and MODIS
```{r, eval = FALSE}
path <- "/u/lestes/spatial_data/globcover_2009/"
if(!file.exists(full_path(path, "globSA_alb.tif"))) {
  url <- "http://due.esrin.esa.int/globcover/LandCover2009/Globcover2009_V2.3_Global_.zip"
  download.file(url, method="auto", destfile = "globcover_2009.zip")
  unzip("globcover_2009.zip", exdir= "globcover_2009")
  glob <- raster(full_path(path, "GLOBCOVER_L4_200901_200912_V2.3.tif"))
  globSA <- crop(glob, y=sa_buf_gcs)  # crop to extent of SA
  gdalwarp(srcfile = globSA@file@name, dstfile = full_path(path, "globSA_alb.tif"), t_srs = prjstr, 
           tr = c(300, 300))
  globSA_alb <- raster(full_path(path, "globSA_alb.tif"))
} else {
  globSA_alb <- raster(full_path(path, "globSA_alb.tif"))
}

# MODIS landcover 
moddir <- "/u/lestes/spatial_data/MCD12Q1/"
if(!file.exists(full_path(moddir, "modis_type_1_alb.tif"))) {
  tiles <- expand.grid("h" = c(19, 20), "v" = c(11, 12))
  tiles <- apply(tiles, 1, function(x) paste("h", x[1], "v", x[2], sep = ""))
  url <- "http://e4ftl01.cr.usgs.gov/MOTA/MCD12Q1.051/2011.01.01/"
  tile.names <- getURL(url, verbose=TRUE, dirlistonly = TRUE) 
  tile.names1 <- strsplit(tile.names, "alt")[[1]]
  tile.names2 <- unique(substr(tile.names1, 20, 64))
  modnames <- tile.names2[sapply(tiles, function(x) grep(x, tile.names2))]
  lapply(modnames, function(x) {
    url <- paste("http://e4ftl01.cr.usgs.gov/MOTA/MCD12Q1.051/2011.01.01/", x, sep = "")
    download.file(url, method="auto", destfile = x)
  })
  dir.create("MCD12Q1")
  file.copy(from = dir(pattern = "hdf"), to = paste(getwd(), "MCD12Q1", dir(pattern = "hdf"), sep = "/"))
  file.remove(dir(pattern = "hdf"))
  
  modis <- dir(moddir)

  # Translate to geotiff
  lapply(1:5, function(x) {
    batch_gdal_translate(infiles = modis, outdir = moddir, 
                         outsuffix = paste("_LC_", x, ".tif", sep = ""), sd_index = x)  
  })
  sdnames <- lapply(1:5, function(x) dir(moddir, pattern  = paste("LC_", x, ".tif", sep = "")))
  
  # warp to albers, mosaic, and clip to SA extent
  lapply(1:5, function(x) {
    print(paste("processing type", x))
    gdalwarp(srcfile = sdnames[[x]], dstfile = paste("modis_type_", x, "_alb.tif", sep = ""), 
             t_srs = prjstr, tr = res(r), te = bbox(sa.buf)[1:4])
  })  
  mod_1 <- raster("modis_type1_alb.tif")
} else {
  mod_1 <- raster(full_path(moddir, "modis_type_1_alb.tif"))
}

```

And then South Africa's landcover database (30 m)
```{r, eval = FALSE}
path <- "/u/lestes/spatial_data/sa_lc_2009/"
setwd("/u/lestes/spatial_data/")
lcnm <- c("sa_ag.tif", "sa_af.tif")
if(length(dir(p_data, pattern = "sa_.*._masked.tif")) != 2) {
  url <- "http://planet.uwc.ac.za/BGISdownloads/landcover_2009.zip"
  download.file(url, method="auto", destfile = "sa_landcover_2009.zip")
  unzip("landcover_2009.zip", exdir = "sa_lc_2009")
  
  setwd(path)
  gdal_translate(src_dataset = "landcover", dst_dataset = "sa_lc_2009.tif", of = "GTiff", ot = "BYTE")
  #system(paste("rm -r", full_path(path, "landcover")))
  #file.remove("../landcover_2009.zip")
    
  # process masks--extract extract landcover class 2, cultivation, and class 6, plantations, resample, mask 
  # with gdal tools
  av <- c(2, 6)
  a <- "sa_lc_2009.tif"
  dang <- Sys.time() 
  salc_l <- lapply(1:2, function(j) {
    print(paste("extracting cover for", lcnm[j]))
    gdal_calc(cstr = paste("A==", av[j], sep = ""), x = list("A" = a), type = "Byte", filename = lcnm[j])
    nm <- full_path(p_data, paste(gsub("\\.tif", "", lcnm[j]), "_masked.tif", sep = ""))
    ext <- sapply(c("xmin", "ymin", "xmax", "ymax"), function(x) slot(extent(sa_r), x))
    print(paste("warping and masking", gsub(p_data, "", nm)))
    gdalwarp(srcfile = lcnm[j], t_srs = projection(sa_r), dstfile = nm, r = "average", ot = "Float32", 
             te = ext, srcnodata = 255, dstnodata = 255, tr = c(1000, 1000), of = "GTiff", verbose = TRUE,
             overwrite = TRUE)
    file.remove(lcnm[j])
    r <- raster(nm)
  })
  Sys.time() - dang
  plot(salc_l[[2]])

} else {
  lcmnm <- paste(gsub("\\.tif", "", lcnm), "_masked.tif", sep = "")
  salc_l <- lapply(lcmnm, function(x) raster(full_path(p_data, x)))
} 
```

Create mask to remove sugarcane growing regions
```{r, eval = FALSE}
if(!file.exists(full_path(p_data, "kzn_cane_masked.tif"))) {
  path <- "/u/lestes/spatial_data/kzn_landcover/"
  setwd(kznpath)
  gdal_translate(src_dataset = "kznlc11v1w31", dst_dataset= "kznlandcover.tif", of = "GTiff")
  system(paste("rm -r", full_path(path, "kznlc11v1w31")))
  kznlc <- raster(full_path(npath, "kznlandcover.tif"))

  # system call to gdal_calc.py to extract landcover class 2, cultivation
  kznlconm <- "kzn_cane.tif"  # file.remove(kznlconm)
  kzninnm <- strsplit(kznlc@file@name, "/")[[1]][length(strsplit(kznlc@file@name, "/")[[1]])]
  # kzninnm <- strsplit(kznlc.ss@file@name, "/")[[1]][length(strsplit(kznlc.ss@file@name, "/")[[1]])]
  pcalc <- paste("gdal_calc.py -A ", kzninnm, " --outfile=", kznlconm, 
                 " --overwrite --calc='(A==9)|(A==10)'", sep = "")
  system.time(system(pcalc))  # 49 seconds
  kzn_cane <- raster(full_path(path, kznlconm))
  # cext <- extent(c(20000, 40000, -3220000, -3200000))  # crops to small extent for examination
  # kznlc.ss <- crop(kznlc, cext, filename = full_path(kznpath, "kznlandcover_crop.tif"), overwrite = TRUE)
  # plot(kznlc.ss)
  # scane1 <- (kznlc.ss == 9); scane2 <- (kznlc.ss == 10)
  # plot(scane1, add = TRUE, col = c("transparent", "red"))
  # plot(scane2, add = TRUE, col = c("transparent", "purple"))
  # chk <- crop(kzn_cane, cext)
  # plot(chk); plot(scane1, add = TRUE, col = c("transparent", "red"), legend = FALSE) 
  # plot(scane2, add = TRUE, col = c("transparent", "red"), legend = FALSE)
  # file.remove("kznlandcover_crop.tif")
  # rm(chk, kznlc.ss, scane1, scane2)
  file.remove("kznlandcover.tif")
  
  # Warp and resample to SA grid
  setwd(p_data)
  gdalwarp(srcfile = kzn_cane@file@name, t_srs = projection(sa.r), dstfile = "kzn_cane_1km.tif", 
           r = "average", ot = "Float32", srcnodata = 255, tr = c(1000, 1000), of = "GTiff", 
           verbose = TRUE, overwrite = TRUE)
  kzn_1km <- raster(full_path(p_data, "kzn_cane_1km.tif"))
  kzn_1km_r <- resample(kzn_1km, sa.r, method = "bilinear")
  kzn_1km_m <- mask(kzn_1km_r, sa.r, filename = full_path(p_data, "kzn_cane_masked.tif"), 
                    overwrite = TRUE)
} else {
  kzn_1km_m <- raster(full_path(p_data, "kzn_cane_masked.tif"))
} 

```

Create low, medium, high cover fraction variants from MODIS classes 12 and 14 (from the IGBP-DIS scheme). Class 14 is a cropland mosaic class, with minimum of 10% and a max of 60%, so create variants of 10%, 35% (mean) and 60%. 
```{r, eval = FALSE}
if(any(!file.exists(full_path(p_data, dir(p_data, pattern = "mod_1*.*1kmrect_sum.tif"))))) {
  # MODIS, using main classification scheme (IGBP-DIS)
  mod_1_crop <- stack(mod_1 == 12, mod_1 == 14)
  mod_1_cropb <- brick(mod_1_crop)
  names(mod_1_crop) <- c("cropland", "mosaic")
  
  # assign percentages
  minset <- c(100, 10)  # assume 10% is minimum crop cover for MODIS IGBP mosaic class
  meanset <- c(100, 35)  # assume 35% is mean crop cover
  maxset <- c(100, 60)  # assume 60% is mean crop cover  
  modsa_min <- assignLCPct(mod_1_cropb, minset, fname = full_path(p_data, "mod_1_min.tif"))
  modsa_mu <- assignLCPct(mod_1_cropb, meanset, fname = full_path(p_data, "mod_1_mu.tif"))
  modsa_max <- assignLCPct(mod_1_cropb, maxset, fname = full_path(p_data, "mod_1_max.tif"))
  
  # aggregate, resample, mask to SA grid
  modsa_list <- lapply(list(modsa_min, modsa_mu, modsa_max), function(x) {
    nm <- gsub("//.tif", "", x@file@name)
    print(paste("Processing", nm))
    print("...aggregating")
    agg <- aggregate(x, fact = 2, na.rm = TRUE)  
    print("...resampling")
    crop1km <- resample(agg, sa.r, method = "bilinear")
    print("...masking")
    crop1km <- mask(crop1km, mask = sa.r, filename = paste(nm, "_1kmrect.tif", sep = ""), overwrite = TRUE)
    return(crop1km)
  })
  
  # And them create single raster with summed proportions
  modsa_list_sum <- lapply(modsa_list, function(x) {
    nm <- paste(gsub("\\.tif", "", x@file@name), "_sum.tif", sep = "")
    paste(nm)
    calc(x, sum, filename = nm, overwrite = TRUE)
  })
} else {
  modsa_list_sum <- lapply(full_path(p_data, dir(p_data, "mod_1*.*1kmrect_sum.tif")[c(2:3, 1)]), raster)
}  
```

And the same for GlobCover. We want Globcover class 11 (irrigated cropland), class 14 (rainfed), 20 (50-70% cropland), and 30 (20-50% cropland). For the latter two classes we create variants assumung the minimum, mean, and max of earh class
```{r, eval = FALSE}
if(any(!file.exists(full_path(p_data, dir(p_data, "globSA*.*1kmrect_sum.tif"))))) {
  l <- lapply(c(11, 14, 20, 30), function(x) r <- globSA_alb == x)  # pull out classes
  s <- stack(l)
  globSA_cropb <- brick(full_path(p_data, "globSA_crop.grd"))
  rm(s, l)
  
  # assign percentages
  minset <- c(100, 100, 50, 20)
  maxset <- c(100, 100, 70, 50)
  meanset <- c(100, 100, 60, 35)
  globsa_min <- assignLCPct(globSA_cropb, minset, fname = full_path(p_data, "globSA_300_min.tif"))
  globsa_mu <- assignLCPct(globSA_cropb, meanset, fname = full_path(p_data, "globSA_300_mu.tif"))
  globsa_max <- assignLCPct(globSA_cropb, maxset, fname = full_path(p_data, "globSA_300_max.tif"))
  glob300list <- lapply(dir(pattern = "globSA_300+.+tif")[c(2:3, 1)], raster)
 
  # Aggregate them and resample and mask to SA grid
  globsa_list <- lapply(list(globsa_min, globsa_mu, globsa_max), function(x) {
    nm <- gsub("_300|.tif", "", x@file@name)
    print(paste("Processing", nm))
    print("...aggregating")
    agg <- aggregate(x, fact = 3, na.rm = TRUE)  # equivalent to summing, dividing by 900
    print("...resampling")
    crop1km <- resample(agg, sa.r, method = "bilinear")
    print("...masking")
    crop1km <- mask(crop1km, mask = sa.r, filename = paste(nm, "_1kmrect.tif", sep = ""), 
                    overwrite = TRUE)
    return(crop1km)
  })
  
  # And them create single raster with summed proportions
  globsa_list_sum <- lapply(globsa_list, function(x) {
    nm <- paste(gsub("\\.tif", "", x@file@name), "_sum.tif", sep = "")
    paste(nm)
    calc(x, sum, filename = nm)
  })
} else {
  globsa_list_sum <- lapply(full_path(p_data, dir(p_data, "globSA*.*1kmrect_sum.tif")[c(2:3, 1)]), raster)
} 
```

Bring in GTI cropland fractions to set up masks
```{r, eval = FALSE}
# Bring in SA landcover sets and mask
cover2007 <- brick(full_path(p_data, "cover2007.tif"))
cover2011 <- brick(full_path(p_data, "cover2011.tif"))

# sum these also with and without horticulture
sumfun <- function(x) sum(x, na.rm = TRUE)
gti <- lapply(list(cover2007, cover2011), function(y) {
  r <- calc(y[[-6]], sumfun)
  r[r > 100] <- 100
  writeRaster(r, file = gsub("\\.tif", "sum.tif", y@file@name), overwrite = TRUE)
}) 

# Leave commented out in case want to bring back horticulture class
# gti_hort <- lapply(list(cover2007, cover2011), function(y) {
#   r <- calc(y, sumfun)
#   r[r > 100] <- 100
#   writeRaster(r, file = gsub("\\.tif", "sum_h.tif", y@file@name), overwrite = TRUE)
# }) 

# Remove communal farmlands
sust_mask_2011 <- cover2011[[2]] > 0  
sust_mask_2007 <- cover2007[[2]] > 0

# Set up SA mask including sugarcane and forestry -- add in Mpumalanga sugar cane when it becomes available
m1 <- kzn_1km_m
m1[is.na(m1)] <- 0
m1[m1 > 0] <- NA
m2 <- salc_l[[2]]
m2[is.na(m2)] <- 0
m2[m2 > 0] <- NA
sa_masks <- sa_r > 0
sa_masks <- m1 + m2 + sa_masks
rm(m1, m2)

# create additional masks for areas of subsistence agriculture
mask_list <- lapply(list(sust_mask_2007, sust_mask_2011), function(x) {
  m <- x
  m[is.na(m)] <- 0
  m[m > 0] <- NA
  mr <- m + sa_masks
  mr
})
mask_list <- c(sa_masks, mask_list)
names(mask_list) <- c("stand", "nosubs_2007", "nosubs_2011")
brick(stack(mask_list), file = full_path(p_data, "mask_brick.tif"), overwrite = TRUE)

# Fix values greater than 100% and apply masks
r <- gti[[1]]
lapply(1:2, function(x) {
  out_name <- paste(gsub("\\.tif", "", r@file@name), "_", names(mask_list)[x], ".tif", sep = "")
  mask(r, mask_list[[x]], file = out_name, overwrite = TRUE)
})  
r <- gti[[2]]
lapply(c(1, 3), function(x) {
  out_name <- paste(gsub("\\.tif", "", r@file@name), "_", names(mask_list)[x], ".tif", sep = "")
  mask(r, mask_list[[x]], file = out_name, overwrite = TRUE)
})  
# Comment out variants including horticulture
# r <- gti_hort[[1]]
# lapply(1:2, function(x) {
#   out_name <- paste(gsub("\\.tif", "", r@file@name), "_", names(mask_list)[x], ".tif", sep = "")
#   mask(r, mask_list[[x]], file = out_name, overwrite = TRUE)
# })  
# r <- gti_hort[[2]]
# lapply(c(1, 3), function(x) {
#   out_name <- paste(gsub("\\.tif", "", r@file@name), "_", names(mask_list)[x], ".tif", sep = "")
#   mask(r, mask_list[[x]], file = out_name, overwrite = TRUE)
# })  

```





