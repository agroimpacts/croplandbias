---
title: "Calculating cropland biases"
author: "Lyndon Estes"
date: "01 October 2014"
output:
  html_document:
    highlight: tango
    theme: spacelab
    toc: yes
---

## Overview
This section of the analysis calculates the differences between the GTI cropland percentages and those from the various landcover products. It draws from results generated by the [cropland pre-processing](https://github.com/PrincetonUniversity/SAcropland/blob/master/vignettes/sa-cropland-analysis.Rmd). (Note to self here: I want to have a transportable link between chapters here, rather than a direct link to the other RMD document in 
github).

## Analyses
### Sidebar
I am just learing how to use Rmarkdown with Rmd files to document analyses that are more interactive in nature. That means that analyses that are not necessarily repeated many times are going to be documented in an Rmd file with text and code so that the analysis can be followed nicely. Code that will be re-used multiple times will go into a library. 

One things I am noticing is that the knit process for compiling the notebook does not find functions within code chunks unless the libraries are called within the code chunks themselves. It seems like each code chunk is its own environment.  The solution to this is to do something like `raster::raster()` when you want a function, or run this where chunks are set to {r, eval = FALSE}, and just run the code chunk as if you were in a normal R script working interactively.  I have already set up the library for SAcropland to call the packages its needs so they are loaded up in the global environment. 

### Load in data
1. Set up paths
```{r, eval = FALSE}
p_root <- proj_root("SAcropland")
p_data <- full_path(p_root, "SAcropland/data/")
```

2. Load cropland grids 
  + Derived from global landcover products

```{r, eval = FALSE}
salc <- raster(full_path(p_data, "salc_ag_masked.tif")) * 100
globsa_list_sum <- lapply(full_path(p_data, dir(p_data, "globSA*.*1kmrect_sum.tif")[c(2:3, 1)]), raster)
modsa_list_sum <- lapply(full_path(p_data, dir(p_data, "mod_1*.*1kmrect_sum.tif")[c(2:3, 1)]), raster)
glcsa <- raster(full_path(p_data, "glcsa_masked.tif"))
lclist <- c(salc, globsa_list_sum, modsa_list_sum, glcsa)  # into list
names(lclist) <- c("sa30", "globmin", "globmu", "globmax", "modmin", "modmu", "modmax", "glcsh")
```

  + SA landcover data
```{r, eval = FALSE}
load(full_path(p_data, "MZshapes.Rdata"))  
paths <- full_path(p_data, dir(p_data, paste("cover*.*sum_nh_[subs|stand]*", sep = "")))[c(2, 4, 1, 3)]
gti_nohort <- lapply(paths, raster)
paths <- full_path(p_data, dir(p_data, paste("cover*.*sum_h_[subs|stand]*", sep = "")))[c(2, 4, 1, 3)]
gti_hort <- lapply(paths, raster)
```

### Calculate differences at different levels of aggregation
This steps draws on functions I wrote to calculate the actual and absolute differences between a given "master" grid and lists of other grids. This comparison is done at multiple aggregations, ranging from 1-600 km resolution cropland averages. The lists have two levels of nesting, here the upper provides the resolution, the inner provides the different landcover datasets. 
```{r, eval = FALSE}
# Mean landcover between 2007 and 2011
gti_nohort2 <- c(gti_nohort, calc(stack(gti_nohort[1:2]), mean), calc(stack(gti_nohort[3:4]), mean))
names(gti_nohort2) <- c("gti2007", "gti2011", "gti2007_ns", "gti2011_ns", "gtimu", "gtimu_ns")

# Aggregate rasters
fact <- c(5, 10, 20, 50, 100, 200, 300, 600)
lc_agg <- aggregate_rast_list(fact, lclist)   # landcover rasters 
gti_nh_agg <- aggregate_rast_list(fact, gti_nohort2)  # GTI rasters
      
# Actual differences
diff_list_act <- lapply(1:6, function(x) {
  print(paste("processing", x))
  diffr <- diff_rast_list(1:length(lc_agg), subtractor = lc_agg, subtractee = gti_nh_agg, whichdiff = x)
})
names(diff_list_act) <- c("d2007", "d2007_ns", "d2011", "d2011_ns", "dmu", "dmu_ns")  

# Absolute differences
diff_list_abs <- lapply(1:6, function(x) {
  print(paste("processing", x))
  diffr <- diff_rast_list(1:length(lc_agg), subtractor = lc_agg, subtractee = gti_nh_agg, whichdiff = x, 
                            abs = TRUE)
})
names(diff_list_abs) <- c("d2007", "d2007_ns", "d2011", "d2011_ns", "dmu", "dmu_ns")  
  
# Between 2007 and 2011 GTI
diff_list_gti <- diff_rast_list(1:length(gti_nh_agg), gti_nh_agg, gti_nh_agg, 4)
  
save(diff_list_act, diff_list_abs, diff_list_gti, file = full_path(p_data, "difference_grid_lists.rda"))
```

### Bias as function of cropcover
Values from the bias rasters calculated in the previous section are binned by percent cropland cover.  There are a couple of tricky aspects here, namely related to choosing which cropland map provides the bins. The 2011 GTI mapset more closely corresponds to the MODIS and GLC-SHARE datasets in time, whereas GlobCover and the SA landcover dataset fall closer to or are between the 2007 mapset. __Wayforward__: Calculate whether there is any bias between the 2007 and 2011 cropland estimates by GTI. And also see how much difference exists in bias estimates _as a function of cropcover_ when 2011 GTI provides the bin estimates, and the difference rasters are calculated against different GTI datasets (2007, the mean of 2007 and 2011, and 2011). 

Another complication is the landcover classes to include in the GTI data.  Originally I had the subsistence class added in, but I am now only going to use the no-subsistence set. The no-subsistence set masks out all areas having subsistence class > 10% of coverage in the pixel--why not zero? Because I am mainly trying to get rid of those really large areas where GTI drew a huge polygon around really big communal farmlands.  Including these would cause a cropland over-estimate for those areas). The inclusion of the slight tolerance for this class allows for some misinterpretation error (subsistence field versus non-subsistence field confusion). 

```{r, eval = FALSE}
binv <- seq(0, 100, 5)  # cropland bins

# GTI versus GTI (to measure difference in the different permutations of GTI)
extract_bin_values(gti_nh_agg, "gti2011_ns", diff_list_gti, binv, full_path(p_data, "gti_diff_bin")) 

# Actual landcover differences relative to GTI
mind <- c("gti2011_ns", "gtimu_ns", "gti2007_ns")
dind <- c("d2011_ns", "dmu_ns", "d2007_ns")
onm <- c("act_2011_ns_bin", "act_mu_ns_bin", "act_2007_ns_bin")
lapply(1:3, function(x) {
  extract_bin_values(gti_nh_agg, mind[x], diff_list_act[[dind[x]]], binv, full_path(p_data, onm[x]))
})

# Absolute landcover differences
# a.First group is using 2011 to provide bins
onm <- c("abs_2011_ns_bin", "abs_2011_v_mu_ns_bin", "abs_2011_v_2007_ns_bin")
lapply(1:3, function(x) {
  extract_bin_values(gti_nh_agg, mind[x], diff_list_abs[[dind[x]]], binv, full_path(p_data, onm[x]))
})
```

### Calculate biases
#### For GTI data
```{r, eval = FALSE}
load(full_path(p_data, "gti_diff_bin.rda"))
gti_bias <- bin_stats(bin_val_list, fun.list = list(mean), binv)
```

#### For difference rasters
```{r, eval = FALSE}
nms <- full_path(p_data, paste(c("act_2011_ns_bin", "act_mu_ns_bin", "act_2007_ns_bin"), ".rda", sep = ""))
bin_act <- lapply(nms, function(x) {
  load(x)
  bin_val_list
})

lapply(1:3, function(x) bin_act[[x]][[7]]$sa30)


```











