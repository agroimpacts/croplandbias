---
title: "Plotting cropland biases"
author: "Lyndon Estes"
date: "06 October 2014"
output: 
  html_document:
    highlight: tango
    theme: spacelab
    toc: yes 
---

## Plotting bias figures
### Biases in space
Load in necessary datasets

```{r, eval = FALSE}
library(raster)
library(lmisc)
library(R.utils)

# Paths
p_root <- proj_root("SAcropland")
p_fig <- full_path(p_root, "SAcropland/paper/figures/")
p_data <- full_path(p_root, "SAcropland/external/ext_data/")

# Load in datasets
load(full_path(p_data, "MZshapes.Rdata"))  # SA shape
load(full_path(p_data, "d_grid_act.rda"))  # actual diffence grids
load(full_path(p_data, "d_grid_abs.rda"))  # actual diffence grids
load(full_path(p_data, "bias_stats.rda"))  # bias statistics
load(full_path(p_data, "bias_stats_gti.rda"))  # bias statistics
```

Plot maps of biases at different resolutions, for publication output (and display here). To avoid the visual distortion of NA areas filled in by larger levels of aggregation, each aggregated difference must be disaggregated first and then masked before plotting.   
```{r, eval = FALSE}
namask <- raster(full_path(p_data, "namask.tif"))
snms <- c("sa30", "globmu", "modmu", "geow")  # all lc data (no MOD/GC extremes)
lev <- c("f1", "f25", "f50", "f100")  # just show four levels

# disggregate selected rasters at selected levels
disagg <- lapply(snms, function(x) {
  l1 <- lapply(lev, function(y) {
    if(y == "f1") {
      r <- dlist_act[[x]][[y]]$g2011
    } else {
      r <- disaggregate(dlist_act[[x]][[y]]$g2011, 
                        fact = as.numeric(gsub("f", "", y)))
      r <- raster::mask(crop(r, namask), namask)
    }
  })
  named_out(l1, lev)
})
names(disagg) <- snms
```

Plot of selected rasters and levels 
```{r, eval = FALSE}
# Plotting colors
cols <- colorRampPalette(c("red", "grey80", "blue4"))
brks <- c(-100.1, -75, -50, -25, -10, 0, 10, 25, 50, 75, 100.1)
n_cols <- length(brks) - 1
legtext <- "% Difference"
cx <- 1.4
lcol <- "black"
mcap <- c("SA-LC", "GlobCover", "MODIS", "GeoWiki")
lev2 <- c("1 km", "25 km", "50 km", "100 km")
pdf(full_path(p_fig, "bias_map.pdf"), height = 6, width = 7)
par(mfrow = c(4, 4), mar = c(0, 0, 0, 0), oma = c(5, 5, 2, 0))
for(i in 1:length(snms)) {
  print(snms[i])
  for(j in 1:length(lev)) {
    print(lev[j])
    plot(sa.shp, lty = 0)
    plot(disagg[[snms[i]]][[lev[j]]], add = TRUE, col = cols(n_cols), 
         breaks = brks, legend = FALSE)
  if(j == 1) mtext(mcap[i], side = 2, line = 1, cex = cx)
  if(i == 1) mtext(lev2[j], side = 3, line = 0, cex = cx)
  }
}
flex_legend(ncuts = length(brks) - 1, legend.text = legtext, 
            legend.vals = round(brks), 
            longdims = c(0.2, 0.8), shortdims = c(0.06, 0.01), 
            colvec = cols(length(brks) - 1), 
            srt = c(270, 0), horiz = TRUE, textside = "bottom", 
            legend.pos = c(4, 5), leg.adj = list(c(0.25, 0), c(0.5, -0.5)), 
            cex.val = cx, textcol = lcol, bordercol = lcol)
dev.off()
```
The map below was created by the code above, showing biases at 1 km, 25 km, 50 km, and 100 km from South Africa's landcover product, the mean estimates from 
GlobCover and MODIS, and Geowiki/GLC-SHARE.  

<p align="center"><img src="../paper/figures/bias_map.pdf" width="400px"></p> 

[[back to top]][Plotting bias figures]

### Bias in relation to field density
1. Supplementary figures - bias plots at 1 km with boxplots.

```{r, eval = FALSE}
#btype <- c("bias_act.pdf", "bias_abs.pdf")
# plot matrix
nc <- 4
m <- matrix(rep(c(rep(1, 8), rep(2, 8), rep(3, 8), rep(4, 8)), 2), nrow = 6, 
            ncol = 32, byrow = TRUE) 
cols <- c("red", "orange3", "green4", "blue", "yellow")
bcol <- c("grey50", "grey50", "grey50", "grey")
lcnms <- c("SA LC", "GlobCover", "MODIS", "Geowiki")
fcol <- "grey"
lev <- names(dstats_all$act$sa30)
lvec <- seq(5, 100, 5)
pp <- list("x" = c(-2, 21), "y" = c(0, 0), 
           "x21" = list(c(0, 9), c(9, 21)),
           "y2" = list(c(seq(-100, -10, 10), seq(10, 100, 10)), 
                       seq(10, 100, 10)), 
           "y1lwd" = list(2, 1),  
           "y2lwd" = 0.5, #c(1, 0.5, 1, 0.5, 0.5, 0.5, 0.5, 1, 0.5, 1),
           "y2lc" = list(c("black", rep("grey80", 4), "black", rep("grey80", 4), 
                           rep("grey80", 4), "black", rep("grey80", 4),"black"),
                         rep("grey80", 10)),
           "yl" = list(c(-100, 100), c(0, 100)), 
           #"yl2" = list(c(-40, 40), c(0, 60)), "xl" = c(1, 20),
           "yl2" = c(-20, 60), "xl" = c(1, 20),
           "xaxl" = unlist(lapply(seq(5, 100, 10), function(x) c(x, " "))),
           "xaxl2" = ifelse(seq(5, 100, 5) %in% c(25, 50, 75), seq(5, 100, 5), 
                            " "),
           "yax1" = list(seq(-100, 100, 50), seq(0, 100, 20)), 
           #"yax2" = list(
            # unlist(lapply(seq(-40, 40, 20), function(x) c(" ", x)))[-1], 
            # unlist(lapply(seq(0, 60, 20), function(x) c(" ", x)))[-1]),
           #"yaxp" = list(-100, 0), 
           "ycol" = c("grey70"))  # plot parameters

pdf(full_path(p_fig, "biases_1km.pdf"), width = 7, height = 5)
lmat <- rbind(m, m + max(m))
l <- layout(lmat)
par(mar = c(3, 0, 0, 0), oma = c(1, 4, 2, 2))
for(bt in 1:2) {
  snms <- names(dstats_all[[bt]])[names(dstats_all[[bt]]) != "glcsh"]
  dset <- dstats_all[[bt]][snms]
  for(i in 1:length(snms)) { i
    d <- dset[[snms[i]]]$f1
    n <- nrow(d)
    plot(pp$x, pp$y, ylim = pp$yl[[bt]], xlim = pp$xl, type = "l", 
         lwd = pp$y1lwd[[bt]], axes = FALSE, 
         xlab = "", ylab = "")
    if(i == 1) axis(2, at = pp$yax1[[bt]], labels = pp$yax1[[bt]], las = 2, 
                    mgp = c(1, 0.6, 0))
    axis(1, at = 1:20, labels = pp$xaxl, las = 2, mgp = c(1, 0.4, 0), 
         tcl = -0.3, pos = pp$yaxp[[bt]], cex = 0.8)
    for(z in 1:length(pp$y2[[bt]])) {
      lines(pp$x, rep(pp$y2[[bt]][z], 2), lwd =pp$y2lwd, col = pp$y2lc[[bt]][z])
    }
    for(k in 1:n) {
      a <- seq(grep("2.5", colnames(d)), by = 1, length.out = 6)
      if(!is.na(d[k, 2])) {
        boxplot_v(k, d[k, a], n, 150, 10, bcol, fcol, pcex = 0.5, 
                  lwd = c(1, 0.5, 2))
      }
    }
    lines(1:n, d[, "mu"], pch = 20, col = cols[i], lwd = 3)
    if(i == 1) mtext(ifelse(bt == 1, "% bias", "% bias (absolute)"), side = 2, 
                     line = 2.2, cex = 0.8)
    if(bt == 1) mtext(lcnms[i], side = 3, line = 0, col = cols[i])
  }
}
mtext("% cropland", side = 1, outer = TRUE, line = -1, cex = 0.8)
dev.off()
```

2. Bias with scale
```{r, eval=FALSE}
lev <- lev[!lev %in% c("f5", "f300")]
levnms <- paste(gsub("f", "", lev), "km")
m2 <- unlist(lapply(seq(1, by = 1, length = length(lev) * 4), function(x) {
  rep(x, nc)
}))
m3 <- do.call(rbind, lapply(seq(1, length(m2), length(lev) * nc), function(x) {
  do.call(rbind, rep(list(m2[x:(x + length(lev) * nc - 1)]), nc))
})) 

yl <- seq(pp$yl2[1], pp$yl2[2], 10)
ylcol <- c("black", "grey", "black", rep("grey", 5), "black")
lt <- c(5, 1)
ylwd <- c(1.5, 2)

pdf(full_path(p_fig, "biases_1-200km.pdf"), width = 7.5, height = 7)
l <- layout(m3)
# i <- 1; j <- 1
par(mar = c(0.5, 0, 1, 0.3), oma = c(5, 4, 2, 2))
for(i in 1:length(snms)) {
  highcounter <- rep(0, length(lev))
  for(j in 1:length(lev)) {
    plot(pp$x, pp$y, ylim = pp$yl2, xlim = pp$xl, type = "l", lwd = 1, 
         axes = FALSE, xlab = "", ylab = "", xaxs = "i")
    for(z in 1:length(yl)) {
      lines(pp$x, rep(yl[z], 2), lwd = pp$y2lwd, col = ylcol[z])
    }
    muv <- rep(NA, 2)
    for(bt in 1:2) {
      d <- dstats_all[[bt]][[i]][[j]]
      n <- nrow(d)
      lines(1:n, d[, "mu"], pch = 20, col = cols[i], lwd = ylwd[bt], 
            lty = lt[bt])
      muv[bt] <- round(mean(d[, 8], na.rm = TRUE))
      toohigh <- which(d[, "mu"] > pp$yl2[2])
      if(length(toohigh) > 0) {
        highcounter[j] <- 1
        xi <- toohigh[which.max(d[toohigh, "mu"])]
        text(xi, y = pp$yl2[2] + 4, labels = round(d[xi, "mu"]), cex = 1.1,
             col = "grey50", xpd = NA)
      }
    }
    text(5, pp$yl2[2] - 14, labels = paste(muv, collapse = " / "), cex = 1.1, 
         col = "grey10")
    if(j == 1) axis(2, at = yl, labels = yl, las = 2, mgp = c(1, 0.6, 0))
    if(j == 1) mtext(lcnms[i], side = 2, line = 2.8, cex = 1, col = cols[i])
    if(i == 1) mtext(levnms[j], side = 3, line = -0.4, cex = 1.2)
    axis(1, at = c(1, 5, 10, 15, 20), labels = rep("", 5), mgp = c(1, 1, 0), 
         tcl = -0.7, lwd.ticks = 1.2, pos = pp$yl2[1])
    axis(1, at = 1:20, labels = rep("", 20), las = 2, mgp = c(1, 0.4, 0), 
         tcl = -0.3, pos = pp$yl2[1])
    if(i == length(snms)) {
      axis(1, at = 1:20, labels = pp$xaxl2, las = 2, mgp = c(1, 0.8, 0), 
           tcl = -0.3, pos = pp$yl2[1])
    }
  }
}
mtext("% bias", side = 2, line = 2.1, cex = 0.8, outer = TRUE, adj = 0.5)
mtext("% cropland", side = 1, outer = TRUE, line = 1.5, cex = 0.8)
par(xpd = NA)
x <- grconvertX(0.75, from = "ndc", to = "user")
y <- grconvertY(0.07, from = "ndc", to = "user")
legend(x = x, y = y, legend = c("actual bias", "absolute bias"), lty = lt, 
       lwd = ylwd, bty = "n", cex = 1.2)
dev.off()

DF <- do.call(rbind.data.frame, lapply(snms[4], function(x) {
  dstats_all[[2]][[x]]$f1[, c(1, 8)]
}))
dlm <- lm(mu ~ poly(V1, degree = 2), data = DF)
plot(DF[, 1], DF[, 2])
lines(predict.lm(dlm, newdata = data.frame("V1" = 1:110)))
```






